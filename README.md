# PskOnline X20 USB 2.0 fingertip PPG waveform sensor based on STM32F103C8T6 + MAX30102

## Copyright and license

The software contained in the repository is a part of PskOnline-X20 open source hardware project, 
which follows the below definition: https://www.oshwa.org/definition/

* The generated portions of the files contained in the repository and other files generated 
by STM32CubeMX tool are copyright STMicroelectronics. These files are licensed under the license 
terms included into each of the files.
* Other files are created by Alexey Adadurov and licensed under MIT license (see the LICENSE file)

## Features

* Obtain PPG waveform using MAX30102 sensor
* Transmit PPG waveform data to the host via USB interface
* Sampling rate: XXX Hz / YY bits per sample
* Ring buffer for 1000 samples
* WinUSB compatible - requires no custom drivers on Windows 7 and later
* Unique serial numbers based on the MCU's unique ID
* Open source .Net client (https://github.com/adadurov/PskOnline.X20.DotNet) 
* Custom PCB and enclosure (work in progress - to be published as open hardware)

## Using VID & PID with derived products

When customizing the hardware or the firmware, it is your responsibility to obtain a unique value for VID & PID 
to use in the products derived from this project. 

## Data retrieval

The host or the client application can retrieve PPG waveform samples by sending 'Start' command and continuously reading endpoint 0x81 afterwards.
The client should expect the package of at least ```%bytes_per_transfer%``` bytes. Client can find out this value by reading ```%x20_capabilities_descriptor``` structure (see Commands section below).

## Commands

The sensor supports several commands that provide the sensor's capabilities information and control its operation.
The commands are sent to the USB Control endpoint (EP 0) as Vendor requests to Interface.

The command codes are defined in ./Inc/command.h 

### GetCapabilitiesDescriptor

Retrieves the Capabilities Descriptor (a vendor-defined structure -- see ./Inc/commands.h) containing information 
about firmware revision, sampling rate, bits per sample, bytes per waveform transfer etc.

### UsePpg

Switches to PPG waveform mode. In this mode the device transmits PPG waveform data.

### UseTestRamp

Switches to the ramp testing mode. In this mode the device generates and transmits the ramp signal instead of the PPG waveform 
to assist with testing of the client data retrieval code.

### Start

Clears the internal ring buffer and starts transmission of the PPG waveform data (or ramp) on endpoint 0x81.

### Stop

Stops transmission of the PPG waveform data.

## Prototyping Components

* Bluepill board (https://wiki.stm32duino.com/index.php?title=Blue_Pill) based on STM32F103C8T6 chip or a replacement.
* MAX30102 (https://datasheets.maximintegrated.com/en/ds/MAX30102.pdf) breakout board (https://ru.aliexpress.com/item/TZT-MH-ET-LIVE-MAX30102/32902336311.html?spm=a2g0s.9042311.0.0.3b0033edxrZMlh)

## Development tips

The code is based on CDC implementation generated by STM32CubeMX.

### Development environment

* System Workbench for STM32 (Eclipse-based): http://www.openstm32.org
* STLink v.2 (or compatible) JTAG module with SWD feature
* USB to Serial Converter based on CH340

Remember to set the target to software based reset (Project -> Debug Congiruations -> Debuggin -> Show generation parameters)


### Filter for basic USB debugging with Microsoft Message Analyzer

Filter: UsbSpec.UsbDeviceId == "VID_0x0483&PID_0x575D"

### Baud rate settings for debugging console

CH340-based bridge
Windows baud rate: 1843200

STM32 baud rate: 1943200 
(a bit higher to help fit into the clock rate margin)
